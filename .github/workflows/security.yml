name: DevSecOps Pipeline - E-commerce

on: [push, pull_request]

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # 1. BUILD - Backend
  # Construit l'image Docker du backend
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  build-backend:
    name: ğŸ—ï¸ Build Backend
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Build Backend Docker image
        run: docker build -t ecommerce-backend:${{ github.sha }} ./backend

      - name: Save backend image
        run: docker save ecommerce-backend:${{ github.sha }} > backend-image.tar

      - name: Upload backend artifact
        uses: actions/upload-artifact@v4
        with:
          name: backend-image
          path: backend-image.tar

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # 2. BUILD - Frontend
  # Construit l'image Docker du frontend
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  build-frontend:
    name: ğŸ—ï¸ Build Frontend
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Build Frontend Docker image
        run: docker build -t ecommerce-frontend:${{ github.sha }} ./frontend

      - name: Save frontend image
        run: docker save ecommerce-frontend:${{ github.sha }} > frontend-image.tar

      - name: Upload frontend artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-image
          path: frontend-image.tar

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # 3. SAST - Analyse statique du code
  # DÃ©tecte les vulnÃ©rabilitÃ©s dans le CODE SOURCE
  # Outil : Semgrep avec rÃ¨gles OWASP Top 10
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  sast:
    name: ğŸ” SAST
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run Semgrep
        uses: returntocorp/semgrep-action@v1
        with:
          config: >-
            p/security-audit
            p/secrets
            p/owasp-top-ten
            p/javascript
            p/react

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # 4. SCA - Analyse des dÃ©pendances Backend
  # DÃ©tecte les vulnÃ©rabilitÃ©s dans les dÃ©pendances npm du backend
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  sca-backend:
    name: ğŸ“¦ SCA Backend
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        working-directory: ./backend
        run: npm install

      - name: npm audit
        working-directory: ./backend
        run: |
          npm audit --json > audit-backend.json
          npm audit

      - uses: actions/upload-artifact@v4
        with:
          name: npm-audit-backend
          path: backend/audit-backend.json

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # 5. SCA - Analyse des dÃ©pendances Frontend
  # DÃ©tecte les vulnÃ©rabilitÃ©s dans les dÃ©pendances npm du frontend
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  sca-frontend:
    name: ğŸ“¦ SCA Frontend
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        working-directory: ./frontend
        run: npm install

      - name: npm audit
        working-directory: ./frontend
        run: |
          npm audit --json > audit-frontend.json
          npm audit

      - uses: actions/upload-artifact@v4
        with:
          name: npm-audit-frontend
          path: frontend/audit-frontend.json

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # 6. SECRET DETECTION
  # DÃ©tecte les SECRETS hardcodÃ©s : clÃ©s API, tokens, mots de passe
  # Outil : Gitleaks
  # âš ï¸ Critique : Ã©vite les fuites de credentials
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  secrets:
    name: ğŸ” Secrets
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # 7. CONTAINER SCAN - Backend
  # Scanne l'image Docker backend
  # Outil : Trivy
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  container-scan-backend:
    name: ğŸ³ Container Scan Backend
    runs-on: ubuntu-latest
    needs: build-backend
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: backend-image

      - name: Load backend image
        run: docker load < backend-image.tar

      - name: Trivy scan backend
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ecommerce-backend:${{ github.sha }}
          format: 'table'
          exit-code: '1'
          severity: 'CRITICAL'

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # 8. CONTAINER SCAN - Frontend
  # Scanne l'image Docker frontend
  # Outil : Trivy
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  container-scan-frontend:
    name: ğŸ³ Container Scan Frontend
    runs-on: ubuntu-latest
    needs: build-frontend
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: frontend-image

      - name: Load frontend image
        run: docker load < frontend-image.tar

      - name: Trivy scan frontend
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ecommerce-frontend:${{ github.sha }}
          format: 'table'
          exit-code: '1'
          severity: 'CRITICAL'

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # 9. CONTAINER SCAN - MongoDB
  # Scanne l'image Docker MongoDB
  # DÃ©tecte les CVE dans l'image de base mongo:5.0
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  container-scan-mongodb:
    name: ğŸ³ Container Scan MongoDB
    runs-on: ubuntu-latest
    steps:
      - name: Trivy scan MongoDB image
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'mongo:5.0'
          format: 'table'
          exit-code: '1'
          severity: 'CRITICAL'

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # 9. RAPPORT FINAL
  # GÃ©nÃ¨re un rÃ©sumÃ© de tous les scans de sÃ©curitÃ©
  # VÃ©rifie le statut de chaque job et fait Ã‰CHOUER le pipeline si des vulnÃ©rabilitÃ©s sont dÃ©tectÃ©es
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  report:
    name: ğŸ“Š Report
    runs-on: ubuntu-latest
    needs: [sast, sca-backend, sca-frontend, secrets, container-scan-backend, container-scan-frontend, container-scan-mongodb]
    if: always()
    steps:
      - name: Generate JSON Report
        run: |
          cat > security-report.json <<EOF
          {
            "timestamp": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
            "repository": "${{ github.repository }}",
            "commit": "${{ github.sha }}",
            "branch": "${{ github.ref_name }}",
            "workflow_run": "${{ github.run_id }}",
            "results": {
              "sast": {
                "status": "${{ needs.sast.result }}",
                "tool": "Semgrep"
              },
              "sca_backend": {
                "status": "${{ needs.sca-backend.result }}",
                "tool": "npm audit",
                "component": "backend"
              },
              "sca_frontend": {
                "status": "${{ needs.sca-frontend.result }}",
                "tool": "npm audit",
                "component": "frontend"
              },
              "secrets": {
                "status": "${{ needs.secrets.result }}",
                "tool": "Gitleaks"
              },
              "container_scan_backend": {
                "status": "${{ needs.container-scan-backend.result }}",
                "tool": "Trivy",
                "component": "backend"
              },
              "container_scan_frontend": {
                "status": "${{ needs.container-scan-frontend.result }}",
                "tool": "Trivy",
                "component": "frontend"
              },
              "container_scan_mongodb": {
                "status": "${{ needs.container-scan-mongodb.result }}",
                "tool": "Trivy",
                "component": "mongodb"
              }
            },
            "summary": {
              "total_checks": 7,
              "passed": $(echo '${{ needs.sast.result }} ${{ needs.sca-backend.result }} ${{ needs.sca-frontend.result }} ${{ needs.secrets.result }} ${{ needs.container-scan-backend.result }} ${{ needs.container-scan-frontend.result }} ${{ needs.container-scan-mongodb.result }}' | grep -o "success" | wc -l),
              "failed": $(echo '${{ needs.sast.result }} ${{ needs.sca-backend.result }} ${{ needs.sca-frontend.result }} ${{ needs.secrets.result }} ${{ needs.container-scan-backend.result }} ${{ needs.container-scan-frontend.result }} ${{ needs.container-scan-mongodb.result }}' | grep -o "failure" | wc -l),
              "overall_status": "$([[ "${{ needs.sast.result }}" == "failure" ]] || [[ "${{ needs.sca-backend.result }}" == "failure" ]] || [[ "${{ needs.sca-frontend.result }}" == "failure" ]] || [[ "${{ needs.secrets.result }}" == "failure" ]] || [[ "${{ needs.container-scan-backend.result }}" == "failure" ]] || [[ "${{ needs.container-scan-frontend.result }}" == "failure" ]] || [[ "${{ needs.container-scan-mongodb.result }}" == "failure" ]] && echo "FAILED" || echo "PASSED")"
            }
          }
          EOF

          echo "ğŸ“„ Security Report Generated:"
          cat security-report.json | jq '.'

      - name: Upload JSON Report
        uses: actions/upload-artifact@v4
        with:
          name: security-report
          path: security-report.json

      - name: Summary
        run: |
          echo "## ğŸ”’ Security Scan Complete - E-commerce App" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Job Results:" >> $GITHUB_STEP_SUMMARY
          echo "- SAST: ${{ needs.sast.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- SCA Backend: ${{ needs.sca-backend.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- SCA Frontend: ${{ needs.sca-frontend.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Secrets: ${{ needs.secrets.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Container Scan Backend: ${{ needs.container-scan-backend.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Container Scan Frontend: ${{ needs.container-scan-frontend.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Container Scan MongoDB: ${{ needs.container-scan-mongodb.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ“¥ **JSON Report available in artifacts**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ needs.sast.result }}" == "failure" ]] || \
             [[ "${{ needs.sca-backend.result }}" == "failure" ]] || \
             [[ "${{ needs.sca-frontend.result }}" == "failure" ]] || \
             [[ "${{ needs.secrets.result }}" == "failure" ]] || \
             [[ "${{ needs.container-scan-backend.result }}" == "failure" ]] || \
             [[ "${{ needs.container-scan-frontend.result }}" == "failure" ]] || \
             [[ "${{ needs.container-scan-mongodb.result }}" == "failure" ]]; then
            echo "âŒ **Security issues detected!**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âš ï¸ Please review the failed jobs above" >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "âœ… All security checks passed" >> $GITHUB_STEP_SUMMARY
          fi
