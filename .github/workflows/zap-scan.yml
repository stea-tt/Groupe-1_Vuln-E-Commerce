name: OWASP ZAP Security Scan

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  schedule:
    # Scan automatique tous les lundis Ã  2h du matin
    - cron: '0 2 * * 1'
  workflow_dispatch:  # Permet de lancer manuellement

jobs:
  zap-baseline-scan:
    name: ZAP Baseline Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Build and start application
        run: |
          echo "ðŸš€ DÃ©marrage de l'application e-commerce..."
          docker-compose up -d --build
          echo "â³ Attente du dÃ©marrage complet..."
          sleep 45

      - name: Verify backend is running
        run: |
          echo "ðŸ” VÃ©rification du backend..."
          for i in {1..10}; do
            if curl -sf http://localhost:5001/health > /dev/null; then
              echo "âœ… Backend accessible"
              exit 0
            fi
            echo "â³ Tentative $i/10..."
            sleep 5
          done
          echo "âŒ Backend inaccessible aprÃ¨s 50 secondes"
          docker-compose logs
          exit 1

      - name: Verify frontend is running
        run: |
          echo "ðŸ” VÃ©rification du frontend..."
          curl -sf http://localhost:3000 > /dev/null || echo "âš ï¸  Frontend inaccessible (non bloquant)"

      - name: ZAP Baseline Scan - Backend API
        uses: zaproxy/action-baseline@v0.10.0
        with:
          target: 'http://localhost:5001'
          rules_file_name: '.zap/rules.tsv'
          cmd_options: '-a -j'
          allow_issue_writing: false
          fail_action: false  # Ne pas faire Ã©chouer le job (pour analyse)

      - name: ZAP Baseline Scan - Frontend
        uses: zaproxy/action-baseline@v0.10.0
        with:
          target: 'http://localhost:3000'
          rules_file_name: '.zap/rules.tsv'
          cmd_options: '-a -j'
          allow_issue_writing: false
          fail_action: false

      - name: Upload ZAP Backend Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: zap-backend-report
          path: |
            report_html.html
            report_json.json
            report_md.md

      - name: Parse ZAP Results
        if: always()
        run: |
          if [ -f report_json.json ]; then
            echo "ðŸ“Š Analyse des rÃ©sultats ZAP..."

            # Installer jq si nÃ©cessaire
            sudo apt-get update && sudo apt-get install -y jq

            HIGH=$(jq '[.site[]?.alerts[]? | select(.riskcode=="3")] | length' report_json.json)
            MEDIUM=$(jq '[.site[]?.alerts[]? | select(.riskcode=="2")] | length' report_json.json)
            LOW=$(jq '[.site[]?.alerts[]? | select(.riskcode=="1")] | length' report_json.json)

            echo "======================================"
            echo "ðŸ“Š RÃ‰SUMÃ‰ DU SCAN OWASP ZAP"
            echo "======================================"
            echo "ðŸ”´ Alertes HIGH   : $HIGH"
            echo "ðŸŸ  Alertes MEDIUM : $MEDIUM"
            echo "ðŸŸ¡ Alertes LOW    : $LOW"
            echo "======================================"

            # CrÃ©er un rÃ©sumÃ© pour GitHub
            echo "### ðŸ” OWASP ZAP Scan Results" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Niveau | Nombre |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|--------|" >> $GITHUB_STEP_SUMMARY
            echo "| ðŸ”´ HIGH | $HIGH |" >> $GITHUB_STEP_SUMMARY
            echo "| ðŸŸ  MEDIUM | $MEDIUM |" >> $GITHUB_STEP_SUMMARY
            echo "| ðŸŸ¡ LOW | $LOW |" >> $GITHUB_STEP_SUMMARY

            # Lister les alertes HIGH
            if [ "$HIGH" != "0" ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "#### ðŸ”´ Alertes critiques (HIGH)" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              jq -r '.site[]?.alerts[]? | select(.riskcode=="3") | "- **\(.alert)** - `\(.url)`"' report_json.json >> $GITHUB_STEP_SUMMARY
            fi

            # Faire Ã©chouer le job si vulnÃ©rabilitÃ©s HIGH
            if [ "$HIGH" != "0" ]; then
              echo "âŒ Le scan a trouvÃ© $HIGH vulnÃ©rabilitÃ©(s) critique(s)"
              exit 1
            fi
          else
            echo "âš ï¸  Rapport JSON non trouvÃ©"
          fi

      - name: Show application logs
        if: failure()
        run: |
          echo "ðŸ“‹ Logs du backend:"
          docker-compose logs backend
          echo ""
          echo "ðŸ“‹ Logs du frontend:"
          docker-compose logs frontend

      - name: Stop application
        if: always()
        run: |
          echo "ðŸ›‘ ArrÃªt de l'application..."
          docker-compose down -v
          docker system prune -af

  zap-full-scan:
    name: ZAP Full Scan (Weekly)
    runs-on: ubuntu-latest
    # Ne s'exÃ©cute que sur schedule ou manuellement
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Build and start application
        run: |
          docker-compose up -d --build
          sleep 45

      - name: Verify application
        run: |
          curl -sf http://localhost:5001/health || exit 1

      - name: ZAP Full Scan
        uses: zaproxy/action-full-scan@v0.8.0
        with:
          target: 'http://localhost:5001'
          rules_file_name: '.zap/rules.tsv'
          cmd_options: '-a -j'
          allow_issue_writing: false
          fail_action: false

      - name: Upload ZAP Full Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: zap-full-report
          path: |
            report_html.html
            report_json.json
            report_md.md

      - name: Stop application
        if: always()
        run: docker-compose down -v

  zap-api-scan:
    name: ZAP API Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Build and start application
        run: |
          docker-compose up -d --build
          sleep 45

      - name: Verify backend
        run: |
          curl -sf http://localhost:5001/health || exit 1

      - name: Create API endpoints file
        run: |
          cat > api_endpoints.txt <<EOF
          http://localhost:5001/health
          http://localhost:5001/api/products
          http://localhost:5001/api/products/search?q=test
          http://localhost:5001/api/users
          http://localhost:5001/api/users/1
          http://localhost:5001/api/admin/stats
          http://localhost:5001/api/debug
          EOF

      - name: ZAP API Scan
        uses: zaproxy/action-api-scan@v0.6.0
        with:
          target: 'http://localhost:5001/api'
          format: 'openapi'
          cmd_options: '-a'
          allow_issue_writing: false
          fail_action: false

      - name: Upload ZAP API Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: zap-api-report
          path: |
            report_html.html
            report_json.json

      - name: Stop application
        if: always()
        run: docker-compose down -v
